<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>JLWLIMOU åå°ç®¡ç† | Pro ç‰ˆ</title>
    <style>
        :root { --accent: #ffcc00; --bg: #0a0a0a; --card: #161616; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; padding: 20px; }
        .box { max-width: 900px; margin: 0 auto; background: var(--card); border-radius: 12px; border: 1px solid #222; overflow: hidden; }
        .tabs { display: flex; background: #222; }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #777; cursor: pointer; font-weight: bold; }
        .tab-btn.active { color: var(--accent); background: var(--card); border-bottom: 2px solid var(--accent); }
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }
        .group { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #252525; }
        label { display: block; color: var(--accent); font-size: 0.75rem; margin-bottom: 10px; }
        input, textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; box-sizing: border-box; }
        .cat-card { border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .item-row { display: flex; align-items: center; gap: 10px; background: #0c0c0c; padding: 10px; margin-top: 10px; border-radius: 4px; border: 1px solid #222; }
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top: 4px solid var(--accent); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-main { background: var(--accent); color: #000; border: none; padding: 18px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 8px; font-size: 1rem; transition: 0.3s; }
        .btn-main:disabled { background: #444; cursor: not-allowed; }
        .upload-area { margin-top: 10px; width: 100%; border: 1px dashed #444; background: none; color: #888; padding: 12px; cursor: pointer; border-radius: 6px; }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">
    <div class="spinner"></div>
    <div id="loader-text">æ­£åœ¨å¤„ç†ä¸­...</div>
</div>

<div class="box">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'tab-works')">ä½œå“é›†ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab(event, 'tab-featured')">é¦–é¡µç²¾é€‰é…ç½®</button>
        <button class="tab-btn" onclick="switchTab(event, 'tab-info')">åŸºæœ¬ä¿¡æ¯</button>
        <button class="tab-btn" onclick="switchTab(event, 'tab-about')">ç®€ä»‹ç¼–è¾‘</button>
    </div>

    <div id="tab-works" class="tab-content active">
        <button onclick="addCat()" style="margin-bottom:15px; padding:8px 15px; background:#444; color:#fff; border:none; cursor:pointer; border-radius:4px;">+ æ–°å¢åˆ†ç±»æ¿å—</button>
        <div id="root"></div>
    </div>

    <div id="tab-featured" class="tab-content">
        <div class="group">
            <label>é¦–é¡µå±•ç¤ºä½œå“æ± </label>
            <p style="font-size: 0.8rem; color: #666; margin-bottom: 15px;">åœ¨æ­¤å‹¾é€‰ä½ æƒ³æ”¾åœ¨é¦–é¡µâ€œç²¾é€‰æ ç›®â€çš„ä½œå“ï¼š</p>
            <div id="featured-master-list"></div>
        </div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="group"><label>EMAIL</label><input type="text" id="inp-email" onchange="localData.email=this.value"></div>
        <div class="group"><label>PHONE</label><input type="text" id="inp-phone" onchange="localData.phone=this.value"></div>
    </div>

    <div id="tab-about" class="tab-content">
        <div class="group"><label>ABOUT TEXT</label><textarea id="inp-about" rows="8" onchange="localData.about=this.value"></textarea></div>
    </div>

    <div style="padding: 20px; border-top: 1px solid #222;">
        <div id="status" style="text-align: center; margin-bottom: 10px; color: var(--accent); font-size: 0.85rem; min-height: 1.2em;"></div>
        <button id="save-btn" class="btn-main" onclick="save()">ä¿å­˜å¹¶åŒæ­¥è‡³ GitHub</button>
    </div>
</div>

<script>
    const CONFIG = {
        OWNER: "JLWLIMOU", REPO: "jlwlimou.github.io",
        T1: "Z2hwXzlIMFBEcFoxT2hkQUM2dnQwSGJlYT", T2: "FhcXlHaGJ2RTJFbU1pYQ=="
    };

    let localData = null;

    async function init() {
        toggleLoader(true, "æ­£åœ¨è·å–æœ€æ–°æ•°æ®...");
        try {
            const res = await fetch('data.json?t=' + Date.now());
            localData = await res.json();
            document.getElementById('inp-email').value = localData.email || "";
            document.getElementById('inp-phone').value = localData.phone || "";
            document.getElementById('inp-about').value = localData.about || "";
            render();
            toggleLoader(false);
        } catch(e) { 
            toggleLoader(false);
            msg("æ•°æ®åŠ è½½å¤±è´¥");
        }
    }

    // æ ¸å¿ƒæ¸²æŸ“å‡½æ•°ï¼šä¿®å¤äº†ä¸¢å¤±çš„åˆ—è¡¨å’ŒæŒ‰é’®é€»è¾‘
    function render() {
        const root = document.getElementById('root');
        const featRoot = document.getElementById('featured-master-list');
        root.innerHTML = '';
        featRoot.innerHTML = '';

        localData.categories.forEach((cat, cIdx) => {
            // A. æ¸²æŸ“ä½œå“ç®¡ç†åˆ—è¡¨
            const card = document.createElement('div');
            card.className = 'cat-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <input type="text" value="${cat.name}" onchange="localData.categories[${cIdx}].name=this.value" style="width:70%; font-weight:bold; color:var(--accent)">
                    <button onclick="localData.categories.splice(${cIdx},1);render()" style="background:#cc3333; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">åˆ é™¤åˆ†ç±»</button>
                </div>
                <div id="items-${cIdx}"></div>
                <button class="upload-area" onclick="document.getElementById('file-${cIdx}').click()">+ ä¸Šä¼ æ–‡ä»¶åˆ°è¯¥åˆ†ç±»</button>
                <input type="file" id="file-${cIdx}" style="display:none" onchange="handleUpload(${cIdx}, this)">
            `;
            root.appendChild(card);

            const itemsContainer = document.getElementById(`items-${cIdx}`);
            cat.items.forEach((item, iIdx) => {
                // 1. åˆ—è¡¨ç®¡ç†è¡Œ
                const iRow = document.createElement('div');
                iRow.className = 'item-row';
                iRow.innerHTML = `
                    <input type="checkbox" ${item.featured ? 'checked' : ''} onchange="localData.categories[${cIdx}].items[${iIdx}].featured=this.checked; render()">
                    <span style="font-size:0.7rem; color:#555; flex:1; overflow:hidden;">${item.url}</span>
                    <input type="text" value="${item.title}" onchange="localData.categories[${cIdx}].items[${iIdx}].title=this.value" style="width:40%">
                    <button onclick="localData.categories[${cIdx}].items.splice(${iIdx},1);render()" style="background:#444; color:#fff; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;">âœ•</button>
                `;
                itemsContainer.appendChild(iRow);

                // 2. é¦–é¡µç²¾é€‰é¡µè¡Œ (åŒæ­¥æ¸²æŸ“)
                const fRow = document.createElement('div');
                fRow.className = 'item-row';
                fRow.innerHTML = `
                    <input type="checkbox" ${item.featured ? 'checked' : ''} onchange="localData.categories[${cIdx}].items[${iIdx}].featured=this.checked; render()">
                    <span style="color:var(--accent); font-size:0.75rem; width:100px;">[${cat.name}]</span>
                    <span style="flex:1">${item.title}</span>
                `;
                featRoot.appendChild(fRow);
            });
        });
    }

    async function handleUpload(cIdx, input) {
        const file = input.files[0];
        if(!file) return;
        toggleLoader(true, `æ­£åœ¨æ£€æŸ¥å¹¶ä¸Šä¼ : ${file.name}`);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const token = atob(CONFIG.T1 + CONFIG.T2);
            const content = reader.result.split(',')[1];
            const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${file.name}`;
            
            let sha = null;
            try {
                const check = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                if (check.ok) sha = (await check.json()).sha;
            } catch (e) {}

            const res = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `Upload ${file.name}`, content: content, sha: sha })
            });

            if(res.ok) {
                if (!localData.categories[cIdx].items.some(i => i.url === file.name)) {
                    localData.categories[cIdx].items.push({ 
                        type: file.type.includes('video') ? 'video' : 'image', 
                        url: file.name, title: file.name.split('.')[0], featured: false 
                    });
                }
                render();
                msg("âœ… ä¸Šä¼ æˆåŠŸï¼");
            } else { msg("âŒ ä¸Šä¼ å¤±è´¥"); }
            toggleLoader(false);
        };
    }

    async function save() {
        toggleLoader(true, "æ­£åœ¨ä¿å­˜åˆ°æœåŠ¡å™¨...");
        try {
            const token = atob(CONFIG.T1 + CONFIG.T2);
            const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/data.json`;
            const g = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
            const d = await g.json();
            const p = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ 
                    message: "Update site data", 
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(localData, null, 2)))), 
                    sha: d.sha 
                })
            });
            if(p.ok) {
                msg("ğŸ‰ åŒæ­¥æˆåŠŸï¼");
                if(confirm("åŒæ­¥æˆåŠŸï¼æ˜¯å¦å‰å¾€æŸ¥çœ‹éƒ¨ç½²è¿›åº¦ï¼Ÿ")) window.open(`https://github.com/${CONFIG.OWNER}/${CONFIG.REPO}/actions`, '_blank');
            } else { msg("âŒ ä¿å­˜å¤±è´¥"); }
        } catch(e) { msg("âŒ å‡ºé”™äº†"); }
        toggleLoader(false);
    }

    function addCat() { localData.categories.push({name:"æ–°åˆ†ç±»", items:[]}); render(); }
    function msg(t) { document.getElementById('status').innerText = t; }
    function toggleLoader(s, t) {
        document.getElementById('loader').style.display = s ? 'flex' : 'none';
        document.getElementById('loader-text').innerText = t;
    }
    function switchTab(evt, name) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        evt.currentTarget.classList.add('active');
    }
    init();
</script>
</body>
</html>

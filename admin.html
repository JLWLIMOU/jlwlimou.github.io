<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>JLWLIMOU åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root { --accent: #ffcc00; --bg: #0a0a0a; --card: #161616; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .box { max-width: 900px; margin: 0 auto; background: var(--card); border-radius: 15px; border: 1px solid #222; overflow: hidden; }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .tabs { display: flex; background: #222; border-bottom: 1px solid #333; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: none; color: #888; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .tab-btn.active { color: var(--accent); background: var(--card); border-bottom: 3px solid var(--accent); }
        
        .tab-content { display: none; padding: 30px; }
        .tab-content.active { display: block; }

        /* å†…å®¹æ ·å¼ */
        .group { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        label { display: block; color: var(--accent); font-size: 0.8rem; margin-bottom: 10px; text-transform: uppercase; }
        input, textarea { width: 100%; padding: 12px; background: #000; border: 1px solid #333; color: #fff; border-radius: 6px; box-sizing: border-box; }
        
        /* ä½œå“åˆ—è¡¨æ ·å¼ */
        .cat-card { border: 1px solid #333; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .item-row { display: flex; align-items: center; gap: 10px; background: #111; padding: 8px; margin-top: 8px; border-radius: 4px; }
        .del-btn { background: #ff4444; color: #fff; border: none; border-radius: 4px; padding: 4px 8px; cursor: pointer; font-size: 0.7rem; }
        
        .save-bar { position: sticky; bottom: 0; background: var(--accent); color: #000; padding: 20px; text-align: center; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="box">
    <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'tab-works')">ä½œå“é›†ç®¡ç†</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-info')">ä¸ªäººåŸºæœ¬ä¿¡æ¯</button>
        <button class="tab-btn" onclick="openTab(event, 'tab-about')">ç®€ä»‹ç¼–è¾‘</button>
    </div>

    <div id="tab-works" class="tab-content active">
        <button onclick="addCategory()" style="margin-bottom:20px; padding:10px; border-radius:5px; background:#444; color:#fff; border:none; cursor:pointer;">+ æ–°å¢åˆ†ç±»</button>
        <div id="categories-root"></div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="group">
            <label>è”ç³»é‚®ç®± (QQ Email)</label>
            <input type="text" id="field-email" onchange="localData.email=this.value">
        </div>
        <div class="group">
            <label>è”ç³»ç”µè¯ (Phone)</label>
            <input type="text" id="field-phone" onchange="localData.phone=this.value">
        </div>
    </div>

    <div id="tab-about" class="tab-content">
        <div class="group">
            <label>ä¸ªäººç®€ä»‹æ–‡å­—</label>
            <textarea id="field-about" rows="6" onchange="localData.about=this.value"></textarea>
        </div>
    </div>

    <div class="save-bar" onclick="saveAll()">ä¿å­˜å¹¶åŒæ­¥æ‰€æœ‰ä¿®æ”¹ (è‡³ data.json)</div>
</div>
<div id="status" style="text-align:center; margin-top:15px; color:var(--accent);"></div>

<script>
    let localData = null;
    const CONFIG = {
        OWNER: "JLWLIMOU", REPO: "jlwlimou.github.io",
        TOKEN: "ä½ çš„å‰æ®µ" + "ä½ çš„åæ®µ" 
    };

    // æ ‡ç­¾é¡µåˆ‡æ¢é€»è¾‘
    function openTab(evt, tabName) {
        document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(tb => tb.classList.remove('active'));
        document.getElementById(tabName).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    async function init() {
        const res = await fetch('data.json?t=' + Date.now());
        localData = await res.json();
        // å¡«å…¥åŸºç¡€ä¿¡æ¯
        document.getElementById('field-email').value = localData.email;
        document.getElementById('field-phone').value = localData.phone;
        document.getElementById('field-about').value = localData.about;
        renderWorks();
    }

    function renderWorks() {
        const root = document.getElementById('categories-root');
        root.innerHTML = '';
        localData.categories.forEach((cat, cIdx) => {
            const card = document.createElement('div');
            card.className = 'cat-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <input type="text" value="${cat.name}" onchange="localData.categories[${cIdx}].name=this.value" style="width:70%">
                    <button class="del-btn" onclick="removeCategory(${cIdx})">åˆ é™¤åˆ†ç±»</button>
                </div>
                <div id="items-${cIdx}">
                    ${cat.items.map((item, iIdx) => `
                        <div class="item-row">
                            <span style="font-size:12px; color:#666; flex:1; overflow:hidden;">${item.url}</span>
                            <input type="text" value="${item.title}" onchange="localData.categories[${cIdx}].items[${iIdx}].title=this.value" style="width:40%; padding:4px;">
                            <button class="del-btn" style="background:#555" onclick="removeItem(${cIdx}, ${iIdx})">âœ•</button>
                        </div>
                    `).join('')}
                </div>
                <button onclick="triggerUpload(${cIdx})" style="margin-top:10px; width:100%; border:1px dashed #444; background:none; color:#888; cursor:pointer; padding:5px;">+ æ·»åŠ ä½œå“æ–‡ä»¶</button>
                <input type="file" id="file-${cIdx}" style="display:none" onchange="handleFile(${cIdx}, this)">
            `;
            root.appendChild(card);
        });
    }

    // åŠŸèƒ½å‡½æ•°ï¼šæ·»åŠ åˆ†ç±»
    function addCategory() {
        localData.categories.push({ id: Date.now().toString(), name: "æ–°åˆ†ç±»", items: [] });
        renderWorks();
    }

    // åŠŸèƒ½å‡½æ•°ï¼šåˆ é™¤åˆ†ç±»
    function removeCategory(idx) {
        if(confirm("ç¡®å®šè¦åˆ é™¤æ•´ä¸ªåˆ†ç±»å—ï¼Ÿ")) {
            localData.categories.splice(idx, 1);
            renderWorks();
        }
    }

    // åŠŸèƒ½å‡½æ•°ï¼šåˆ é™¤å•ä¸ªä½œå“
    function removeItem(cIdx, iIdx) {
        localData.categories[cIdx].items.splice(iIdx, 1);
        renderWorks();
    }

    function triggerUpload(idx) { document.getElementById(`file-${idx}`).click(); }

    async function handleFile(catIdx, input) {
        const file = input.files[0];
        if(!file) return;
        document.getElementById('status').innerText = `æ­£åœ¨ä¸Šä¼  ${file.name}...`;
        
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const content = reader.result.split(',')[1];
            const token = atob(CONFIG.TOKEN);
            
            await fetch(`https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${file.name}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `Upload ${file.name}`, content: content })
            });

            localData.categories[catIdx].items.push({
                type: file.type.includes('video') ? 'video' : 'image',
                url: file.name,
                title: file.name.split('.')[0]
            });
            renderWorks();
            document.getElementById('status').innerText = "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼è®°å¾—æœ€åä¿å­˜ç»“æ„ã€‚";
        };
    }

    async function saveAll() {
        const status = document.getElementById('status');
        status.innerText = "ğŸš€ æ­£åœ¨åŒæ­¥è‡³ GitHub...";
        const token = atob(CONFIG.TOKEN);
        
        const res = await fetch(`https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/data.json`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const oldFile = await res.json();

        const putRes = await fetch(`https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/data.json`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}` },
            body: JSON.stringify({
                message: "Update site structure and info",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(localData, null, 2)))),
                sha: oldFile.sha
            })
        });

        if(putRes.ok) status.innerText = "ğŸ‰ æ‰€æœ‰ä¿®æ”¹å·²åŒæ­¥ç”Ÿæ•ˆï¼";
        else status.innerText = "âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Tokenã€‚";
    }

    init();
</script>
</body>
</html>

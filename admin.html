<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>JLWLIMOU åå°ç®¡ç†</title>
    <style>
        body { background: #0a0a0a; color: #fff; font-family: sans-serif; padding: 20px; }
        .box { max-width: 800px; margin: 0 auto; background: #161616; padding: 30px; border-radius: 15px; border: 1px solid #222; }
        .cat-card { background: #222; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #333; }
        .cat-header { display: flex; justify-content: space-between; margin-bottom: 15px; }
        input[type="text"] { background: #000; border: 1px solid #444; color: #fff; padding: 8px; border-radius: 4px; }
        .item-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; background: #111; padding: 8px; border-radius: 4px; font-size: 0.8rem; }
        .btn-add { background: #ffcc00; color: #000; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 20px; }
        .btn-plus { background: #444; color: #fff; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .save-bar { position: sticky; bottom: 20px; background: #ffcc00; color: #000; padding: 20px; text-align: center; font-weight: bold; border-radius: 10px; cursor: pointer; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

<div class="box">
    <h2>ç«™ç‚¹ç»“æ„ç®¡ç†</h2>
    <button class="btn-add" onclick="addCategory()">+ æ·»åŠ æ–°åˆ†ç±»</button>
    
    <div id="editor-root"></div>

    <div class="save-bar" onclick="saveAll()">ä¿å­˜å¹¶åŒæ­¥æ‰€æœ‰ä¿®æ”¹ (éœ€è¦å¡«å…¥ Token)</div>
    <div id="status" style="text-align:center; margin-top:10px; color:#ffcc00;"></div>
</div>

<script>
    let localData = null;
    const CONFIG = {
        OWNER: "JLWLIMOU", REPO: "jlwlimou.github.io",
        TOKEN: "ä½ çš„å‰æ®µ" + "ä½ çš„åæ®µ" // å¡«å…¥ä½ ä¹‹å‰çš„æ‹†åˆ†Token
    };

    async function init() {
        const res = await fetch('data.json?t=' + Date.now());
        localData = await res.json();
        render();
    }

    function render() {
        const root = document.getElementById('editor-root');
        root.innerHTML = '';
        localData.categories.forEach((cat, cIdx) => {
            const div = document.createElement('div');
            div.className = 'cat-card';
            div.innerHTML = `
                <div class="cat-header">
                    <input type="text" value="${cat.name}" onchange="localData.categories[${cIdx}].name=this.value" placeholder="åˆ†ç±»åç§°">
                    <button onclick="removeItem(${cIdx})" style="color:red; background:none; border:none; cursor:pointer;">åˆ é™¤åˆ†ç±»</button>
                </div>
                <div id="items-${cIdx}">
                    ${cat.items.map((item, iIdx) => `
                        <div class="item-row">
                            <span>${item.type === 'video' ? 'ğŸ¬' : 'ğŸ–¼ï¸'}</span>
                            <input type="text" value="${item.title}" onchange="localData.categories[${cIdx}].items[${iIdx}].title=this.value" style="flex:1">
                            <span style="color:#666">${item.url}</span>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-plus" onclick="triggerUpload(${cIdx})">+</button>
                <input type="file" id="file-${cIdx}" style="display:none" onchange="handleFile(${cIdx}, this)">
            `;
            root.appendChild(div);
        });
    }

    function addCategory() {
        localData.categories.push({ id: Date.now().toString(), name: "æ–°åˆ†ç±»", items: [] });
        render();
    }

    function triggerUpload(idx) { document.getElementById(`file-${idx}`).click(); }

    async function handleFile(catIdx, input) {
        const file = input.files[0];
        if(!file) return;
        const status = document.getElementById('status');
        status.innerText = `æ­£åœ¨ä¸Šä¼  ${file.name}...`;

        // 1. ä¸Šä¼ ç‰©ç†æ–‡ä»¶
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const content = reader.result.split(',')[1];
            const token = atob(CONFIG.TOKEN);
            
            // æäº¤æ–‡ä»¶åˆ° GitHub
            await fetch(`https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${file.name}`, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({ message: `Upload ${file.name}`, content: content })
            });

            // 2. æ›´æ–°æœ¬åœ°æ•°æ®ç»“æ„
            localData.categories[catIdx].items.push({
                type: file.type.includes('video') ? 'video' : 'image',
                url: file.name,
                title: file.name.split('.')[0]
            });
            render();
            status.innerText = "æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼Œåˆ«å¿˜äº†æœ€åç‚¹å‡»ä¸‹æ–¹çš„ä¿å­˜ï¼";
        };
    }

    async function saveAll() {
        const status = document.getElementById('status');
        status.innerText = "ğŸš€ æ­£åœ¨ä¿å­˜ç»“æ„...";
        const token = atob(CONFIG.TOKEN);
        
        // è·å–æ—§ SHA
        const res = await fetch(`https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/data.json`, {
            headers: { 'Authorization': `token ${token}` }
        });
        const oldFile = await res.json();

        // æäº¤æ–° data.json
        await fetch(`https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/data.json`, {
            method: 'PUT',
            headers: { 'Authorization': `token ${token}` },
            body: JSON.stringify({
                message: "Update site structure",
                content: btoa(unescape(encodeURIComponent(JSON.stringify(localData, null, 2)))),
                sha: oldFile.sha
            })
        });
        status.innerText = "ğŸ‰ å…¨é¢åŒæ­¥å®Œæˆï¼";
    }

    init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>JLWLIMOU åå°ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        :root { --accent: #ffcc00; --bg: #0a0a0a; --card: #161616; --border: #333; }
        body { background: var(--bg); color: #fff; font-family: -apple-system, sans-serif; padding: 20px; margin: 0; }
        .box { max-width: 900px; margin: 20px auto; background: var(--card); border-radius: 12px; border: 1px solid var(--border); overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        /* å¯¼èˆªæ ‡ç­¾é¡µ */
        .tabs { display: flex; background: #222; border-bottom: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 18px; border: none; background: none; color: #777; cursor: pointer; font-weight: bold; transition: 0.3s; font-size: 0.9rem; }
        .tab-btn.active { color: var(--accent); background: var(--card); border-bottom: 3px solid var(--accent); }
        
        .tab-content { display: none; padding: 30px; min-height: 400px; }
        .tab-content.active { display: block; }

        /* é€šç”¨ç»„ä»¶ */
        .group { background: #1a1a1a; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #252525; }
        label { display: block; color: var(--accent); font-size: 0.75rem; margin-bottom: 10px; letter-spacing: 1px; }
        input, textarea, select { width: 100%; padding: 12px; background: #000; border: 1px solid var(--border); color: #fff; border-radius: 6px; box-sizing: border-box; font-size: 0.95rem; }
        input:focus { border-color: var(--accent); outline: none; }

        /* ä½œå“é¡¹æ ·å¼ */
        .cat-card { border: 1px solid #333; padding: 20px; border-radius: 10px; margin-bottom: 25px; background: #1a1a1a; }
        .item-row { display: flex; align-items: center; gap: 12px; background: #0c0c0c; padding: 10px; margin-top: 10px; border-radius: 6px; border: 1px solid #222; }
        .item-row input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; accent-color: var(--accent); }
        
        /* æŒ‰é’®ç±» */
        .btn-main { background: var(--accent); color: #000; border: none; padding: 15px 30px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; font-size: 1rem; }
        .btn-add-cat { background: #333; color: #fff; border: 1px solid #444; padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
        .btn-del { background: #cc3333; color: #fff; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .btn-upload-trigger { margin-top: 15px; width: 100%; border: 1px dashed #444; background: rgba(255,255,255,0.02); color: #888; cursor: pointer; padding: 10px; border-radius: 6px; }
        .btn-upload-trigger:hover { border-color: var(--accent); color: var(--accent); }

        .save-bar-wrap { position: sticky; bottom: 0; padding: 20px; background: var(--card); border-top: 1px solid var(--border); }
        #status-msg { text-align: center; padding: 10px; font-size: 0.9rem; min-height: 20px; }
    </style>
</head>
<body>

<div class="box">
    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab(event, 'tab-works')">ä½œå“é›†ç®¡ç†</button>
        <button class="tab-btn" onclick="switchTab(event, 'tab-info')">åŸºæœ¬ä¿¡æ¯</button>
        <button class="tab-btn" onclick="switchTab(event, 'tab-about')">ç®€ä»‹ç¼–è¾‘</button>
    </div>

    <div id="tab-works" class="tab-content active">
        <button class="btn-add-cat" onclick="addCategory()">+ æ–°å¢åˆ†ç±»æ¿å—</button>
        <div id="works-root"></div>
    </div>

    <div id="tab-info" class="tab-content">
        <div class="group">
            <label>è”ç³»é‚®ç®± (Email)</label>
            <input type="text" id="inp-email" onchange="localData.email=this.value" placeholder="ä¾‹å¦‚: jlwlimou@qq.com">
        </div>
        <div class="group">
            <label>è”ç³»ç”µè¯ (Phone)</label>
            <input type="text" id="inp-phone" onchange="localData.phone=this.value" placeholder="ä¾‹å¦‚: +86 138...">
        </div>
    </div>

    <div id="tab-about" class="tab-content">
        <div class="group">
            <label>ä¸ªäººç®€ä»‹ (About Text)</label>
            <textarea id="inp-about" rows="8" onchange="localData.about=this.value" placeholder="å†™ä¸€æ®µä»‹ç»è‡ªå·±çš„è¯..."></textarea>
        </div>
    </div>

    <div class="save-bar-wrap">
        <div id="status-msg"></div>
        <button class="btn-main" onclick="saveToGitHub()">ä¿å­˜å¹¶åŒæ­¥æ‰€æœ‰ä¿®æ”¹</button>
    </div>
</div>

<script>
    // --- é…ç½®åŒº ---
    const CONFIG = {
        OWNER: "JLWLIMOU",
        REPO: "jlwlimou.github.io",
        // è¯·åœ¨æ­¤å¤„å¡«å…¥æ‚¨æ‹†åˆ†çš„ Token
        T1: "Z2hwXzlIMFBEcFoxT2hkQUM2dnQwSGJlYT", 
        T2: "FhcXlHaGJ2RTJFbU1pYQ=="
    };

    let localData = null;

    // åˆå§‹åŒ–ï¼šè·å– JSON æ•°æ®
    async function init() {
        showMsg("æ­£åœ¨è¯»å–æ•°æ®...");
        try {
            const res = await fetch('data.json?t=' + Date.now());
            localData = await res.json();
            
            // å¡«å……åŸºç¡€å­—æ®µ
            document.getElementById('inp-email').value = localData.email || "";
            document.getElementById('inp-phone').value = localData.phone || "";
            document.getElementById('inp-about').value = localData.about || "";
            
            renderWorks();
            showMsg("æ•°æ®è¯»å–æˆåŠŸ", "#ffcc00");
        } catch (e) {
            showMsg("è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ data.json æ˜¯å¦å­˜åœ¨", "red");
        }
    }

    // æ¸²æŸ“ä½œå“åˆ—è¡¨
    function renderWorks() {
        const root = document.getElementById('works-root');
        root.innerHTML = '';

        localData.categories.forEach((cat, cIdx) => {
            const card = document.createElement('div');
            card.className = 'cat-card';
            card.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <input type="text" value="${cat.name}" onchange="localData.categories[${cIdx}].name=this.value" style="font-weight:bold; color:var(--accent); width:60%">
                    <button class="btn-del" onclick="deleteCategory(${cIdx})">åˆ é™¤åˆ†ç±»</button>
                </div>
                <div class="items-list">
                    ${cat.items.map((item, iIdx) => `
                        <div class="item-row">
                            <input type="checkbox" ${item.featured ? 'checked' : ''} onchange="localData.categories[${cIdx}].items[${iIdx}].featured=this.checked" title="è®¾ä¸ºé¦–é¡µç²¾é€‰">
                            <span style="font-size:0.7rem; color:#555; width:20%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.url}</span>
                            <input type="text" value="${item.title}" onchange="localData.categories[${cIdx}].items[${iIdx}].title=this.value" style="flex:1; padding:5px;">
                            <button class="btn-del" style="background:#444" onclick="deleteItem(${cIdx}, ${iIdx})">âœ•</button>
                        </div>
                    `).join('')}
                </div>
                <button class="btn-upload-trigger" onclick="document.getElementById('file-${cIdx}').click()">+ æ·»åŠ ä½œå“æ–‡ä»¶ (å›¾ç‰‡/è§†é¢‘)</button>
                <input type="file" id="file-${cIdx}" style="display:none" onchange="handleFileUpload(${cIdx}, this)">
            `;
            root.appendChild(card);
        });
    }

    // äº¤äº’åŠŸèƒ½
    function switchTab(evt, name) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(name).classList.add('active');
        evt.currentTarget.classList.add('active');
    }

    function addCategory() {
        localData.categories.push({ id: "cat_" + Date.now(), name: "æ–°å»ºåˆ†ç±»", items: [] });
        renderWorks();
    }

    function deleteCategory(idx) {
        if(confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªåˆ†ç±»åŠå…¶æ‰€æœ‰ä½œå“å—ï¼Ÿ")) {
            localData.categories.splice(idx, 1);
            renderWorks();
        }
    }

    function deleteItem(cIdx, iIdx) {
        localData.categories[cIdx].items.splice(iIdx, 1);
        renderWorks();
    }

    // æ–‡ä»¶ä¸Šä¼ é€»è¾‘
    async function handleFileUpload(cIdx, input) {
        const file = input.files[0];
        if(!file) return;

        showMsg(`æ­£åœ¨ä¸Šä¼ æ–‡ä»¶: ${file.name}...`);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            try {
                const content = reader.result.split(',')[1];
                const token = atob(CONFIG.T1 + CONFIG.T2);
                
                const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/${file.name}`;
                
                // æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨ä»¥è·å– SHA
                const check = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
                const sha = check.status === 200 ? (await check.json()).sha : null;

                const res = await fetch(url, {
                    method: 'PUT',
                    headers: { 'Authorization': `token ${token}` },
                    body: JSON.stringify({
                        message: `Upload ${file.name}`,
                        content: content,
                        sha: sha
                    })
                });

                if(res.ok) {
                    localData.categories[cIdx].items.push({
                        type: file.type.includes('video') ? 'video' : 'image',
                        url: file.name,
                        title: file.name.split('.')[0],
                        featured: false
                    });
                    renderWorks();
                    showMsg("æ–‡ä»¶ä¸Šä¼ æˆåŠŸï¼è¯·è®°å¾—ä¿å­˜ç»“æ„ã€‚", "lime");
                }
            } catch (e) {
                showMsg("ä¸Šä¼ å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Token", "red");
            }
        };
    }

    // ä¿å­˜æ‰€æœ‰æ•°æ®åˆ° data.json
    async function saveToGitHub() {
        showMsg("ğŸš€ æ­£åœ¨åŒæ­¥è‡³ GitHub...");
        try {
            const token = atob(CONFIG.T1 + CONFIG.T2);
            const url = `https://api.github.com/repos/${CONFIG.OWNER}/${CONFIG.REPO}/contents/data.json`;
            
            const getRes = await fetch(url, { headers: { 'Authorization': `token ${token}` } });
            const fileData = await getRes.json();

            const putRes = await fetch(url, {
                method: 'PUT',
                headers: { 'Authorization': `token ${token}` },
                body: JSON.stringify({
                    message: "Update site data via admin",
                    content: btoa(unescape(encodeURIComponent(JSON.stringify(localData, null, 2)))),
                    sha: fileData.sha
                })
            });

            if(putRes.ok) showMsg("ğŸ‰ åŒæ­¥æˆåŠŸï¼é¡µé¢å·²å®æ—¶æ›´æ–°ã€‚", "lime");
            else showMsg("ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®", "red");
        } catch (e) {
            showMsg("ä¿å­˜å‡ºé”™: " + e.message, "red");
        }
    }

    function showMsg(txt, color = "#888") {
        const m = document.getElementById('status-msg');
        m.innerText = txt;
        m.style.color = color;
    }

    init();
</script>
</body>
</html>

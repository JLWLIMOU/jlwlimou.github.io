<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>JLWLIMOU 后台管理</title>
    <style>
        body { background: #0f0f0f; color: #fff; font-family: sans-serif; padding: 20px; display: flex; justify-content: center; }
        .box { width: 100%; max-width: 500px; background: #1a1a1a; padding: 25px; border-radius: 12px; border: 1px solid #333; }
        input, textarea { width: 100%; padding: 10px; margin: 10px 0; background: #000; border: 1px solid #444; color: #fff; border-radius: 4px; box-sizing: border-box; }
        button { background: #ffcc00; color: #000; border: none; padding: 15px; width: 100%; cursor: pointer; font-weight: bold; border-radius: 4px; margin-top: 20px; }
        .file-zone { background: #222; padding: 15px; border: 1px dashed #444; margin-top: 15px; }
        label { font-size: 0.8rem; color: #888; }
    </style>
</head>
<body>
    <div class="box">
        <h2>全能编辑器</h2>
        <input type="password" id="token" placeholder="粘贴 GitHub Token">
        
        <label>联系方式更新</label>
        <input type="text" id="email" placeholder="新 QQ 邮箱">
        <input type="text" id="phone" placeholder="新 电话号码">
        <textarea id="about" rows="3" placeholder="新 自我介绍"></textarea>

        <div class="file-zone">
            <label>上传作品/简历 (选填)</label>
            <input type="file" id="resFile" accept=".pdf">
            <p style="font-size:0.7rem">上传 PDF 会自动替换简历</p>
            <input type="file" id="workFile" accept=".mp4,.jpg">
            <p style="font-size:0.7rem">上传作品将存为 work1.mp4 或 render1.jpg</p>
        </div>

        <button onclick="doUpdate()">同步更新</button>
        <p id="msg"></p>
    </div>

    <script>
        const toBase64 = f => new Promise((res, rej) => {
            const r = new FileReader(); r.readAsDataURL(f);
            r.onload = () => res(r.result.split(',')[1]); r.onerror = e => rej(e);
        });

        async function uploadFile(token, name, b64) {
            const url = `https://api.github.com/repos/JLWLIMOU/jlwlimou.github.io/contents/${name}`;
            const r = await fetch(url, {headers:{'Authorization':`token ${token}`}});
            const d = await r.json();
            return fetch(url, {
                method: 'PUT',
                headers: {'Authorization':`token ${token}`},
                body: JSON.stringify({message: 'Upload '+name, content: b64, sha: d.sha})
            });
        }

        async function doUpdate() {
            const t = document.getElementById('token').value;
            const m = document.getElementById('msg');
            if(!t) return alert('Token!');
            m.innerText = '正在更新...';

            try {
                // 1. 更新文字
                const url = `https://api.github.com/repos/JLWLIMOU/jlwlimou.github.io/contents/index.html`;
                const r = await fetch(url, {headers:{'Authorization':`token ${t}`}});
                const d = await r.json();
                let c = decodeURIComponent(escape(atob(d.content)));

                const e = document.getElementById('email').value;
                const p = document.getElementById('phone').value;
                const a = document.getElementById('about').value;

                if(e) c = c.replace(/id="email-val">.*?<\/span>/, `id="email-val">${e}</span>`);
                if(p) c = c.replace(/id="phone-val">.*?<\/span>/, `id="phone-val">${p}</span>`);
                if(a) c = c.replace(/id="about-text">.*?<\/p>/, `id="about-text">${a}</p>`);

                await fetch(url, {
                    method: 'PUT',
                    headers: {'Authorization':`token ${t}`},
                    body: JSON.stringify({message: 'Update text', content: b64=btoa(unescape(encodeURIComponent(c))), sha: d.sha})
                });

                // 2. 更新文件
                const rf = document.getElementById('resFile').files[0];
                if(rf) await uploadFile(t, 'resume.pdf', await toBase64(rf));
                
                const wf = document.getElementById('workFile').files[0];
                if(wf) {
                    const name = wf.type.includes('video') ? 'work1.mp4' : 'render1.jpg';
                    await uploadFile(t, name, await toBase64(wf));
                }

                m.innerText = '✅ 更新成功！';
            } catch(e) { m.innerText = '❌ 失败，请检查 Token'; }
        }
    </script>
</body>
</html>
